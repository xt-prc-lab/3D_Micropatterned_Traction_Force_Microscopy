%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                                                              %
%            Experimental correction of the displacement field due to the Refraction Index missmatch of the sample.            %
%                                                                                                                              %
%   Inputs:                                                                                                                    %
%       dx [matrix]: displacement field in the x direction.                                                                    %
%       dy [matrix]: displacement field in the y direction.                                                                    %
%       dz [matrix]: displacement field in the z direction.                                                                    %
%       x [matrix]: x coordinate.                                                                                              %
%       y [matrix]: y coordinate.                                                                                              %
%       z [matrix]: z coordinate.                                                                                              %
%       Settings [structure]: Settings structure. Use the field related to the well size.                                      %
%                                                                                                                              %
%   Outputs:                                                                                                                   %
%       dx_corrected [matrix]: corrected displacement field in the x direction.                                                %
%       dy_corrected [matrix]: corrected displacement field in the y direction.                                                %
%       dz_corrected [matrix]: corrected displacement field in the z direction.                                                %
%                                                                                                                              %
%   Last Revison Date: 22/01/2024                                                                                              %
%   Author: Manuel Gomez Gonzalez                                                                                              %
%                                                                                                                              %
%   References:                                                                                                                %
%       N/A.                                                                                                                   %
%                                                                                                                              %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function [dx_corrected, dy_corrected, dz_corrected] = correct_disp_RI_matched(dx, dy, dz, x, y, z, Settings, varargin)

    dx_corrected = dx;
    dy_corrected = dy;
    dz_corrected = dz;

    if isfield(Settings, "Well_Size") && ((Settings.Well_Size == 15) || (Settings.Well_Size == 19))

        % Empirical shape of the correction function for the RI mismatch, in the vertical wall of the well.
        z_coord  = [-12.07, -11.9 , -11.73, -11.56, -11.39, -11.22, -11.05, -10.88, -10.71, -10.54, -10.37, -10.2 , -10.03, ...
                     -9.86,  -9.69,  -9.52,  -9.35,  -9.18,  -9.01,  -8.84,  -8.67,  -8.5 ,  -8.33,  -8.16,  -7.99,  -7.82, ...
                     -7.65,  -7.48,  -7.31,  -7.14,  -6.97,  -6.8 ,  -6.63,  -6.46,  -6.29,  -6.12,  -5.95,  -5.78,  -5.61, ...
                     -5.44,  -5.27,  -5.1 ,  -4.93,  -4.76,  -4.59,  -4.42,  -4.25,  -4.08,  -3.91,  -3.74,  -3.57,  -3.4 , ...
                     -3.23,  -3.06,  -2.89,  -2.72,  -2.55,  -2.38,  -2.21,  -2.04,  -1.87,  -1.7 ,  -1.53,  -1.36,  -1.19];

        % Empirical shape of the correction function for the RI mismatch, in the horizontal surface of the gel.
        if Settings.Well_Size == 15         % 15um wells.

            z_coord = z_coord(1:end-6);

            % Radial correction on the vertical wall.
            rad_corr = [0.0086589336857263, 0.00998927392018906, 0.0109345660874125, 0.0118066329630419, 0.0127582461684323, ...
                        0.013825317963506 , 0.0149711966963716 , 0.0162289122997816, 0.0176403422894699, 0.0191540970356034, ...
                        0.0207691091496964, 0.0224883158644521 , 0.0242842690240643, 0.0262050337821067, 0.0282921476562546, ...
                        0.0305314710650734, 0.0329312796323502 , 0.0354766595180796, 0.0381094819307713, 0.0408703760912263, ...
                        0.0437871996256458, 0.0468494669588901 , 0.0501403964722541, 0.0536198971843627, 0.0571707776866498, ...
                        0.0607925536709162, 0.0645160274775713 , 0.0683225781184448, 0.0722735975418515, 0.0764256686328858, ...
                        0.0807210146490033, 0.0851994893499136 , 0.0897133970062131, 0.0940695394264323, 0.0983862658393004, ...
                        0.102800254806463 , 0.107240648408751  , 0.111654365902615 , 0.116101933862283 , 0.120449201407025 , ...
                        0.124672399892291 , 0.128765361794344  , 0.132481098120372 , 0.135823708040121 , 0.138935936774922 , ...
                        0.141730907833891 , 0.144145707161767  , 0.146276842462818 , 0.148053672406145 , 0.149492104610942 , ...
                        0.150787627738758 , 0.151997517751     , 0.161319101451724 , 0.14772886418779  , 0.147311062936341 , ...
                        0.149100194589419 , 0.149254844738856  , 0.14967070930787  , 0.150052694721441 ];

            z_coord = z_coord(1:end-7);
            rad_corr = rad_corr(1:end-7);

            r_coord  = [ 5.22375,  5.72125,  6.21875,  6.71625,  7.21375,  7.71125,  8.20875,  8.70625,  9.20375,  9.70125, ...
                        10.19875, 10.69625, 11.19375, 11.69125, 12.18875, 12.68625, 13.18375, 13.68125, 14.17875, 14.67625, ...
                        15.17375, 15.67125, 16.16875, 16.66625, 17.16375, 17.66125, 18.15875, 18.65625, 19.15375, 19.65125, ...
                        20.14875, 20.64625, 21.14375, 21.64125, 22.13875, 22.63625, 23.13375, 23.63125, 24.12875, 24.62625, ...
                        25.12375, 25.62125, 26.11875, 26.61625, 27.11375, 27.61125, 28.10875, 28.60625, 29.10375, 29.60125, ...
                        30.09875, 30.59625, 31.09375, 31.59125, 32.08875, 32.58625, 33.08375, 33.58125, 34.07875, 34.57625, ...
                        35.07375, 35.57125, 36.06875, 36.56625, 37.06375, 37.56125, 38.05875, 38.55625, 39.05375, 39.55125, ...
                        40.04875, 40.54625, 41.04375, 41.54125, 42.03875, 42.53625, 43.03375, 43.53125, 44.02875, 44.52625, ...
                        45.02375, 45.52125, 46.01875, 46.51625, 47.01375, 47.51125, 48.00875, 48.50625, 49.00375, 49.50125];

            % Radial correction on the upper surface.
            rad_corr_s = [ 0.187128833191548  ,  0.175972298464785  ,  0.1710258727113     ,  0.157786297037993  , ...
                           0.13791872396062   ,  0.11579373148712   ,  0.0937719617806357  ,  0.0739272984741291 , ...
                           0.0578714161144451 ,  0.0459691608868396 ,  0.0377853129025753  ,  0.0323762050976087 , ...
                           0.0290626771272499 ,  0.0269936426254104 ,  0.0256225202368207  ,  0.0247615157788481 , ...
                           0.024118783337919  ,  0.0236992024799945 ,  0.0234524153487075  ,  0.0231663390995165 , ...
                           0.0229555051426935 ,  0.0226788702759412 ,  0.0222996595929375  ,  0.0219228582208963 , ...
                           0.021463529044746  ,  0.0210633820539674 ,  0.020644606951666   ,  0.0203127094724334 , ...
                           0.0200011633366742 ,  0.0196578890111391 ,  0.0193862104176701  ,  0.0190956795851556 , ...
                           0.0188586037618658 ,  0.0186917969128315 ,  0.0185984339715255  ,  0.0185805764067936 , ...
                           0.0186569496270365 ,  0.0188027823158837 ,  0.0189976213204296  ,  0.0192639610724874 , ...
                           0.0195098764056161 ,  0.0197500829933214 ,  0.0199898843731565  ,  0.0201484126409511 , ...
                           0.0201358770908907 ,  0.0198639976624107 ,  0.0193745632577992  ,  0.0181307186184388 , ...
                           0.0166678226709208 ,  0.014895166004655  ,  0.0123629159691178  ,  0.00967167949579458, ...
                           0.00610731922209683,  0.00255281023468825,  0.00297946566878646 ,  0.0024508935227887 , ...
                           0.001199190160572  ,  0.00116792221929425,  0.000937038693283514,  0.0010304078899242 , ...
                           0.00121321329935705,  0.00397706539080337,  0.00614762953832564 ,  0.00773567416660644, ...
                           0.00759210845797527,  0.00676081419906086,  0.00468527987393394 ,  0.00324863053769223, ...
                           0.00170483020258224, -2.6189645520899E-05, -0.00246898057400727 , -0.00565375058015071, ...
                          -0.00893583834486099, -0.0116127275592264 , -0.0154121532531816  , -0.0187404071337209 , ...
                          -0.022743417683491  , -0.0279721319291292 , -0.0359648729232484  , -0.0429725296220708 , ...
                          -0.0519861727355457 , -0.0597011939077705 , -0.0571812443816727  , -0.0625173567750202 , ...
                          -0.0732751859966606 , -0.0765491289945115 , -0.0916279652705549  , -0.0962461244290261 , ...
                           0.0168893958127297 ,  0.0149008976955126 ];

        elseif Settings.Well_Size == 19         % 19um wells.

            % Radial correction on the vertical wall.
            rad_corr = [-0.00577528412002284, -0.00392571216380988, -0.00289463483850607 , -0.00226992842341178 , ...
                        -0.00166095184713005, -0.00093536345565152, -9.76752304530829E-05,  0.000796770390029099, ...
                         0.00179902090030952,  0.00290612886692456,  0.00407089305470697 ,  0.00535444981074534 , ...
                         0.00676387999462366,  0.00824377636186202,  0.00986418077864066 ,  0.011632146792225   , ...
                         0.0134759553932442 ,  0.0154637536314143 ,  0.0176117499454754  ,  0.0198306302685645  , ...
                         0.0221673642811821 ,  0.0246476915333201 ,  0.0271890783138285  ,  0.0298231792117078  , ...
                         0.0325712461465017 ,  0.0353670740761631 ,  0.0382336013775362  ,  0.0411934861105369  , ...
                         0.0441869139041368 ,  0.0472164504251553 ,  0.0503047922397785  ,  0.0533946159931838  , ...
                         0.0564435162683183 ,  0.0595003225624346 ,  0.0625407440641213  ,  0.0654627560621162  , ...
                         0.0683133365417381 ,  0.0711387303428217 ,  0.0738267621789765  ,  0.0764139523783267  , ...
                         0.0790045025942799 ,  0.0815122447213952 ,  0.0838167300808135  ,  0.0860015756595669  , ...
                         0.0880621155671337 ,  0.0898912905844727 ,  0.0914517811268125  ,  0.0928568850641248  , ...
                         0.0940706780369372 ,  0.0949838109262284 ,  0.0958020014692015  ,  0.0966108421483843  , ...
                         0.0973416118274223 ,  0.0981411482361013 ,  0.102914324767007   ,  0.116263812528004   , ...
                         0.117786805304568  ,  0.119409263143887  ,  0.121122544060614   ,  0.118354294894481   , ...
                         0.118797660310133  ,  0.137766013484154  ,  0.139792240248655   ,  0.143462229654532   , ...
                         0.149127264551458  ];

            z_coord = z_coord(1:end-11);
            rad_corr = rad_corr(1:end-11);

            r_coord  = [           5.72125,  6.21875,  6.71625,  7.21375,  7.71125,  8.20875,  8.70625,  9.20375,  9.70125, ...
                        10.19875, 10.69625, 11.19375, 11.69125, 12.18875, 12.68625, 13.18375, 13.68125, 14.17875, 14.67625, ...
                        15.17375, 15.67125, 16.16875, 16.66625, 17.16375, 17.66125, 18.15875, 18.65625, 19.15375, 19.65125, ...
                        20.14875, 20.64625, 21.14375, 21.64125, 22.13875, 22.63625, 23.13375, 23.63125, 24.12875, 24.62625, ...
                        25.12375, 25.62125, 26.11875, 26.61625, 27.11375, 27.61125, 28.10875, 28.60625, 29.10375, 29.60125, ...
                        30.09875, 30.59625, 31.09375, 31.59125, 32.08875, 32.58625, 33.08375, 33.58125, 34.07875, 34.57625, ...
                        35.07375, 35.57125, 36.06875, 36.56625, 37.06375, 37.56125, 38.05875, 38.55625, 39.05375, 39.55125, ...
                        40.04875, 40.54625, 41.04375, 41.54125, 42.03875, 42.53625, 43.03375, 43.53125, 44.02875, 44.52625, ...
                        45.02375, 45.52125, 46.01875, 46.51625, 47.01375, 47.51125, 48.00875, 48.50625, 49.00375, 49.50125, ...
                        49.99875];

            % Radial correction on the upper surface.
            rad_corr_s = [                       0.104194142454328  ,  0.108088472354248   ,  0.106969936601205  , ...
                           0.0996442654640499 ,  0.0877106090967504 ,  0.0729376728664163  ,  0.0578342111303143 , ...
                           0.0435325271549136 ,  0.0311005460017509 ,  0.0209596333050843  ,  0.0133982498357942 , ...
                           0.00782666865757332,  0.00375414903536039,  0.000694780083188226, -0.00163797179373355, ...
                          -0.00338088925437616, -0.00456611376009316, -0.00551448059926391 , -0.00625975569995544, ...
                          -0.00689637359227414, -0.00742958196399069, -0.00787743936031811 , -0.00822854422137854, ...
                          -0.0084170540046786 , -0.00865057742127124, -0.00875484731006828 , -0.00884081045481205, ...
                          -0.00885031062310962, -0.00883875453076873, -0.00882511695780259 , -0.0088144400528372 , ...
                          -0.0087745579116093 , -0.0088149501189825 , -0.00892138900397309 , -0.00902930917929195, ...
                          -0.00911201058549504, -0.00923388579977858, -0.00934466027177977 , -0.00945671064586449, ...
                          -0.00953465990032757, -0.00954541550198399, -0.00952257283946406 , -0.00957812795131226, ...
                          -0.00968092177109055, -0.00982081291353199, -0.00995579028287604 , -0.00984463672503569, ...
                          -0.010183777298645  , -0.0107607583363906 , -0.0116385092997705  , -0.0123848204505987 , ...
                          -0.0136329443815748 , -0.0157548276907702 , -0.0182499215398031  , -0.0210643186174539 , ...
                          -0.0211817099461368 , -0.0230419399516702 , -0.0251229325693756  , -0.0246654189847133 , ...
                          -0.022803468387032  , -0.0226605944224162 , -0.0232887560720594  , -0.0235561355892541 , ...
                          -0.0221231356698301 , -0.0215687798819997 , -0.0226247529936593  , -0.0223529825702558 , ...
                          -0.022368146990586  , -0.0243524557048722 , -0.028214918638236   , -0.0298246790072366 , ...
                          -0.028835955811794  , -0.0292590543772716 , -0.0299291030197049  , -0.0299097434121058 , ...
                          -0.0322774115126216 , -0.0337874716681999 , -0.0367415824256749  , -0.0401114911351542 , ...
                          -0.0442294854279017 , -0.0448489087078325 , -0.0454016163501595  , -0.069905657773288  , ...
                          -0.0857600190592946 , -0.0901803339074009 , -0.0805804110243845  , -0.0923078702652274 , ...
                          -0.0968692274671527 , -0.0932069163894076 , -0.100930785088007   ];

        end

        z = z - min(z, [], 'all', 'omitnan') + min(z_coord, [], 'all', 'omitnan');
        z_coord = [z_coord, max(z)];

        % Wall of the well.
        ind_well = (z < max(z));

        rad_corr = [rad_corr, rad_corr_s(1)];

        F = griddedInterpolant(z_coord, rad_corr, 'makima', 'linear');
        disp_corr = F(z(ind_well));

        % Apply the radial correction to the wall of the well.
        dx_corrected(ind_well) = dx(ind_well) - disp_corr.*x(ind_well)./sqrt(x(ind_well).*x(ind_well)+y(ind_well).*y(ind_well));
        dy_corrected(ind_well) = dy(ind_well) - disp_corr.*y(ind_well)./sqrt(x(ind_well).*x(ind_well)+y(ind_well).*y(ind_well));

        % Surface of the gel.
        ind_surf = (z == max(z));

        r = sqrt(x(ind_surf).*x(ind_surf)+y(ind_surf).*y(ind_surf));
        r_coord = r_coord - min(r_coord, [], 'all', 'omitnan') + min(r, [], 'all', 'omitnan');

        F = griddedInterpolant(r_coord, rad_corr_s, 'makima', 'linear');
        disp_corr = F(r);

        % Apply the radial correction to the upper surface.
        dx_corrected(ind_surf) = dx(ind_surf) - disp_corr.*x(ind_surf)./sqrt(x(ind_surf).*x(ind_surf)+y(ind_surf).*y(ind_surf));
        dy_corrected(ind_surf) = dy(ind_surf) - disp_corr.*y(ind_surf)./sqrt(x(ind_surf).*x(ind_surf)+y(ind_surf).*y(ind_surf));

    end

end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%